<!doctype html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>JobQ 대시보드 (Day6)</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; margin: 24px; }
        table { border-collapse: collapse; width: 520px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f6f6f6; }
        .ts { margin: 8px 0 16px; color: #666; font-size: 13px; }
        .warn { color:#b00020; font-size:13px; margin:8px 0 0; }
    </style>
</head>
<body>
<h2>JobQ 대시보드</h2>
<div class="ts" id="ts">-</div>
<div id="warn" class="warn"></div>

<h3>Redis Streams</h3>
<table id="q">
    <thead><tr><th>type</th><th>XLEN</th></tr></thead>
    <tbody></tbody>
</table>

<h3 style="margin-top:24px;">Job 상태</h3>
<table id="jobs">
    <thead><tr><th>Status</th><th>Count</th></tr></thead>
    <tbody></tbody>
</table>

<script>
    const ADMIN_TOKEN = 'test-admin-token';

    const urlToken = new URLSearchParams(location.search).get('token');
    const EFFECTIVE_TOKEN = urlToken || ADMIN_TOKEN;

    function withToken(path) {
        return fetch(path, { headers: { 'X-Admin-Token': EFFECTIVE_TOKEN } });
    }

    async function tick() {
        try {
            const [qRes, jRes] = await Promise.all([
                withToken('/admin/metrics/queue'),
                withToken('/admin/metrics/jobs')
            ]);

            if (!qRes.ok || !jRes.ok) {
                const msg = `인증 실패 또는 오류 (queue:${qRes.status}, jobs:${jRes.status}). 토큰을 확인하세요.`;
                document.getElementById('warn').innerText = msg;
                return;
            } else {
                document.getElementById('warn').innerText = '';
            }

            const q = await qRes.json();
            const j = await jRes.json();

            document.getElementById('ts').innerText = `Updated: ${q.ts ?? '-'}`;

            const qBody = document.querySelector('#q tbody');
            qBody.innerHTML = '';
            Object.entries(q.streams || {}).forEach(([type, v]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${type}</td><td>${v.xlen}</td>`;
                qBody.appendChild(tr);
            });

            const jBody = document.querySelector('#jobs tbody');
            jBody.innerHTML = '';
            Object.entries(j || {}).forEach(([k, v]) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${k}</td><td>${v}</td>`;
                jBody.appendChild(tr);
            });
        } catch (e) {
            console.error(e);
            document.getElementById('warn').innerText = '네트워크 오류: 콘솔을 확인하세요.';
        }
    }

    tick();
    setInterval(tick, 2000);
</script>
</body>
</html>
